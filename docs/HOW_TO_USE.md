# Pet Camera 取扱説明書

## 目次

1. [システム概要](#1-システム概要)
2. [必要な環境](#2-必要な環境)
3. [初期セットアップ](#3-初期セットアップ)
4. [サーバーの起動](#4-サーバーの起動)
5. [Windows サービスとして常時稼働させる](#5-windows-サービスとして常時稼働させる)
6. [スマホからアクセスする](#6-スマホからアクセスする)
7. [画面の使い方](#7-画面の使い方)
8. [カメラ設定の変更](#8-カメラ設定の変更)
9. [TLS 証明書の更新](#9-tls-証明書の更新)
10. [トラブルシューティング](#10-トラブルシューティング)
11. [サービスの管理コマンド](#11-サービスの管理コマンド)
12. [セキュリティについて](#12-セキュリティについて)

---

## 1. システム概要

Pet Camera は、自宅の PC に接続した Web カメラ・マイク・スピーカーを使って、外出先のスマホからペットの様子を見守るシステムです。

**主な機能:**

- ライブ映像の視聴（MJPEG ストリーミング）
- 双方向音声通話（家の音を聞く / スマホからペットに話しかける）
- スナップショットの撮影・保存
- カメラ設定の調整（解像度・FPS・明るさ・コントラスト）

**通信の仕組み:**

```
スマホ ──(Tailscale VPN)──> 自宅 PC (ポート 5555)
         HTTPS + WebSocket (暗号化)
```

Tailscale VPN 経由でのみアクセス可能なため、インターネットに直接公開されません。

---

## 2. 必要な環境

### サーバー側（自宅 PC）

| 項目 | 要件 |
|------|------|
| OS | Windows 10 / 11 |
| Python | 3.10 以上 |
| カメラ | USB または内蔵 Web カメラ |
| マイク | 内蔵またはカメラ付属のマイク |
| スピーカー | PC 内蔵スピーカーまたは外部スピーカー |
| ネットワーク | Tailscale がインストールされていること |

### クライアント側（スマホ）

| 項目 | 要件 |
|------|------|
| OS | iOS / Android |
| ブラウザ | Safari / Chrome（最新版推奨） |
| VPN | Tailscale アプリがインストールされていること |

---

## 3. 初期セットアップ

### 3.1 Python 環境のセットアップ

`setup.bat` をダブルクリックして実行します。以下が自動的に行われます。

- Python の存在確認
- 仮想環境 (`venv/`) の作成
- 依存パッケージのインストール
- 必要なディレクトリ (`certs/`, `logs/`, `snapshots/`) の作成

### 3.2 認証トークンの設定

管理者権限のコマンドプロンプトで以下を実行します。

```batch
setx /M PET_CAMERA_TOKEN "あなたの秘密のトークン文字列"
setx /M PET_CAMERA_ENV "production"
```

- トークンは十分に長いランダムな文字列にしてください（20 文字以上推奨）
- このトークンをスマホからのログイン時に入力します
- 設定後、コマンドプロンプトを再起動すると反映されます

### 3.3 Tailscale の設定

1. [Tailscale](https://tailscale.com/) をサーバー PC とスマホの両方にインストール
2. 同じアカウントでログイン
3. Tailscale 管理コンソールで **MagicDNS** と **HTTPS Certificates** を有効化

### 3.4 TLS 証明書の取得

コマンドプロンプトで以下を実行します。

```batch
tailscale cert --cert-file "certs\あなたのマシン名.tailnet名.ts.net.crt" --key-file "certs\あなたのマシン名.tailnet名.ts.net.key" あなたのマシン名.tailnet名.ts.net
```

マシン名と tailnet 名は Tailscale の管理画面で確認できます。

> **ヒント:** `tailscale status` を実行すると、自分のマシン名が確認できます。

---

## 4. サーバーの起動

### 手動起動（テスト用）

```batch
venv\Scripts\python.exe run.py
```

起動に成功すると以下のようなログが表示されます。

```
INFO: Camera opened (index=0)
INFO: Microphone started
INFO: Speaker started
INFO: TLS using certs\....crt
INFO: Running on https://0.0.0.0:5555
```

停止するには `Ctrl + C` を押します。

---

## 5. Windows サービスとして常時稼働させる

サービスとして登録すると、PC 起動時に自動的にカメラサーバーが立ち上がります。

### 5.1 NSSM のインストール

```batch
winget install NSSM.NSSM
```

### 5.2 サービスの登録

`install-service.bat` を **管理者として実行** します。

以下が自動的に行われます。

- NSSM の検出
- `PET_CAMERA_TOKEN` の確認
- `PetCameraServer` サービスの登録
- 自動起動（PC 起動時）の設定
- 異常終了時の自動再起動設定（5 秒後にリトライ）
- ログファイルのローテーション設定

### 5.3 サービスのパスワード設定

サービスはカメラ・マイクへのアクセスが必要なため、現在のユーザーアカウントで実行されます。`services.msc` で `Pet Camera Server` のプロパティを開き、「ログオン」タブでパスワードを設定してください。

---

## 6. スマホからアクセスする

### 初回アクセス

1. スマホで **Tailscale アプリ** を起動し、VPN に接続
2. ブラウザを開き、以下の URL にアクセス:
   ```
   https://あなたのマシン名.tailnet名.ts.net:5555
   ```
3. ログイン画面が表示されるので、セットアップ時に設定したトークンを入力
4. 「接続」ボタンをタップ
5. ライブ映像の画面に切り替わる

### パスキー（生体認証）の登録

トークン入力の手間を省くため、スマホの指紋認証・顔認証を登録できます。

1. トークンでログインした状態で ⚙ **設定** ボタンをタップ
2. 設定パネルの下部にある「パスキー（生体認証）」セクションを確認
3. **「このデバイスを登録」** ボタンをタップ
4. スマホが指紋認証または顔認証をリクエストするので、認証する
5. 「パスキーを登録しました！」と表示されれば完了

### 2 回目以降

ログインのセッションは **24 時間** 有効です。有効期限内であればトークンの再入力なしで映像が表示されます。

セッションが切れた場合:
- **パスキー登録済み**: ログイン画面の「パスキーでログイン」ボタンをタップ → 指紋/顔認証だけでログイン
- **パスキー未登録**: トークンを入力してログイン

> **注意:** Tailscale VPN に接続していないとアクセスできません。パスキーはデバイスごとに登録が必要です。

---

## 7. 画面の使い方

### 画面構成

```
┌────────────────────────────────────┐
│ Pet Camera          LIVE  00:03:42 │ ← ヘッダー（稼働時間表示）
├────────────────────────────────────┤
│                                    │
│         ライブ映像                  │ ← MJPEG ストリーム
│                                    │
├────────────────────────────────────┤
│ [🔊 聞く] [🎤 話す]    音量 ━━━━  │ ← 音声コントロール
├────────────────────────────────────┤
│ [📷 スナップショット] [💾 保存] [⚙ 設定] │ ← アクションボタン
├────────────────────────────────────┤
│ 15 fps  1280x720  マイク: ON      │ ← ステータスバー
└────────────────────────────────────┘
```

### 音声コントロール

| ボタン | 機能 | 操作 |
|--------|------|------|
| 🔊 **聞く** | 家の音をスマホで聞く | タップで ON/OFF 切替 |
| 🎤 **話す** | スマホの声をペットに届ける | **押している間だけ** マイクが有効 |
| **音量スライダー** | 聞く音の音量調整 | スライダーをドラッグ |

> **ヒント:** 「話す」はプッシュトゥトーク方式です。ボタンを押している間だけ音声が送信されます。エコーやハウリングの防止のため、聞きながら話す場合は音量を下げることを推奨します。

### アクションボタン

| ボタン | 機能 |
|--------|------|
| 📷 **スナップショット** | 現在の映像を JPEG としてスマホにダウンロード |
| 💾 **保存** | 現在の映像をサーバーの `snapshots/` フォルダに保存 |
| ⚙ **設定** | カメラ設定パネルを開く |

### ステータスバー

画面下部に以下の情報がリアルタイム表示されます（3 秒ごとに更新）。

- **FPS:** 現在のフレームレート
- **解像度:** 映像の解像度
- **マイク / リスナー:** マイクの状態と接続中のリスナー数

---

## 8. カメラ設定の変更

⚙ **設定** ボタンをタップすると設定パネルが開きます。

| 項目 | 選択肢 | 初期値 |
|------|--------|--------|
| 解像度 | 640x480 / 1280x720 / 1920x1080 | 1280x720 |
| FPS | 5 / 10 / 15 / 30 | 15 |
| 明るさ | 0〜100 | 50 |
| コントラスト | 0〜100 | 50 |

- **適用:** 変更を反映します。映像が一瞬途切れてから新しい設定で再開します。
- **リセット:** 全項目を初期値に戻します（適用ボタンを押すまで反映されません）。

> **注意:** 解像度を上げると映像品質は向上しますが、通信量が増えます。モバイル回線の場合は 640x480 や低い FPS に設定することを推奨します。

---

## 9. TLS 証明書の更新

Tailscale の証明書は **90 日** で期限切れになります。自動更新を設定済みの場合（Task Scheduler の `PetCamera-CertRenewal` タスク）は自動的に更新されます。

### 手動更新

`renew-cert.bat` を **管理者として実行** します。証明書が更新され、サービスが自動的に再起動されます。

### 自動更新の確認

タスクスケジューラ (`taskschd.msc`) を開き、`PetCamera-CertRenewal` タスクの状態が「準備完了」になっていることを確認してください。

---

## 10. トラブルシューティング

### 映像が表示されない

| 原因 | 対処 |
|------|------|
| カメラが他のアプリに使用されている | Zoom・Teams など他のカメラ使用アプリを終了する |
| カメラのアクセス許可がない | Windows 設定 → プライバシーとセキュリティ → カメラ で許可を確認 |
| サービスが停止している | `nssm status PetCameraServer` で確認し、停止していれば `nssm start PetCameraServer` で起動 |

### 音声が動作しない — 設定確認チェックリスト

音声機能（聞く・話す）が動作しない場合、以下を順番に確認してください。

#### サーバー側（自宅 PC）の確認

- [ ] **マイクが認識されているか**
  - Windows 設定 → システム → サウンド → 入力 でマイクが表示されているか確認
  - 「入力デバイスを選択」でカメラのマイクまたは PC 内蔵マイクが選ばれているか確認
- [ ] **マイクのアクセス許可**
  - Windows 設定 → プライバシーとセキュリティ → マイク → 「マイクへのアクセス」が ON
  - 「デスクトップアプリがマイクにアクセスできるようにする」が ON
- [ ] **スピーカーが認識されているか**
  - Windows 設定 → システム → サウンド → 出力 でスピーカーが表示されているか確認
  - 「出力デバイスを選択」で使用したいスピーカーが選ばれているか確認
- [ ] **サーバーログでマイク・スピーカーの起動を確認**
  - `logs\stderr.log` に以下の 2 行があるか確認:
    ```
    AudioCapture: microphone stream started
    AudioPlayer: speaker stream started
    ```
  - エラーが出ている場合はマイク/スピーカーが他のアプリに占有されている可能性あり
- [ ] **サービスの実行ユーザー**
  - `services.msc` → `Pet Camera Server` → プロパティ → ログオン
  - 「ローカル システム アカウント」ではなく「このアカウント」にユーザーが設定されているか確認
  - ※ローカルシステムではオーディオデバイスにアクセスできない場合がある

#### クライアント側（スマホ）の確認 — 聞く機能

- [ ] **HTTPS でアクセスしているか**
  - URL が `https://` で始まっていることを確認（`http://` では音声機能が動作しない）
- [ ] **スマホ本体の音量**
  - メディア音量がゼロになっていないか確認（サイレントモード解除）
- [ ] **画面上の音量スライダー**
  - スライダーが左端（0）になっていないか確認
- [ ] **ブラウザの自動再生ポリシー**
  - 「聞く」ボタンを押す前に、画面内の何かを一度タップする
  - ブラウザの音声自動再生がブロックされている場合、ユーザー操作が必要
- [ ] **ブラウザの開発者コンソール**
  - ブラウザの開発者ツール（F12）→ Console タブを開く
  - `[Audio] WebSocket connected` が表示されているか確認
  - エラーが表示されている場合はその内容を確認

#### クライアント側（スマホ）の確認 — 話す機能

- [ ] **ブラウザのマイク許可**
  - ブラウザのアドレスバーの鍵アイコン → サイトの設定 → マイク → 「許可」
  - Chrome: `chrome://settings/content/microphone` で確認可能
  - Safari: 設定 → Safari → マイク → 「確認」または「許可」
- [ ] **HTTPS でアクセスしているか**
  - `getUserMedia`（マイクアクセス API）は HTTPS 必須
- [ ] **マイクの権限ダイアログ**
  - 「話す」ボタンを初めて押した時に「マイクへのアクセスを許可しますか？」と表示される
  - 「許可」をタップしたか確認（「ブロック」した場合はブラウザの設定からリセット）

#### 確認方法: サーバーのステータス API

ブラウザで以下の URL にアクセスし、音声の状態を確認できます:

```
https://あなたのマシン名.tailnet名.ts.net:5555/api/status
```

レスポンスの `audio` セクション:
```json
{
  "audio": {
    "microphone_active": true,
    "speaker_active": true,
    "listening_clients": 1
  }
}
```

- `microphone_active` が `false` → サーバーのマイクが起動していない
- `speaker_active` が `false` → サーバーのスピーカーが起動していない
- `listening_clients` が `0` → クライアントがリスニングを開始していない

### ログインできない

| 原因 | 対処 |
|------|------|
| トークンが間違っている | `PET_CAMERA_TOKEN` の環境変数値を確認 |
| レート制限にかかった | 5 回連続で失敗すると 5 分間ブロックされる。5 分待ってから再試行 |

### Tailscale 経由で接続できない

| 原因 | 対処 |
|------|------|
| Tailscale が起動していない | PC とスマホの両方で Tailscale を起動 |
| 異なるアカウントでログインしている | 同じ Tailscale アカウントでログインしているか確認 |
| MagicDNS が無効 | Tailscale 管理コンソールで MagicDNS を有効化 |

### ログの確認

問題が解決しない場合、ログファイルを確認してください。

- **サービスログ:** `logs\stdout.log`, `logs\stderr.log`
- **アクセスログ:** `logs\access.log`

---

## 11. サービスの管理コマンド

コマンドプロンプト（管理者）で以下のコマンドを使えます。

```batch
nssm start PetCameraServer       REM サービスを開始
nssm stop PetCameraServer        REM サービスを停止
nssm restart PetCameraServer     REM サービスを再起動
nssm status PetCameraServer      REM サービスの状態を確認
nssm remove PetCameraServer confirm  REM サービスを完全に削除
```

> **注意:** NSSM が PATH に入っていない場合は、フルパスで実行してください。`install-service.bat` 内のコメントに NSSM のインストール先が記載されています。

---

## 12. セキュリティについて

### 3 層の防御

1. **ネットワーク層 — Tailscale VPN**
   - 同じ Tailnet に所属するデバイスのみがアクセス可能
   - WireGuard による暗号化通信
   - ポート開放不要（インターネットに非公開）

2. **通信層 — HTTPS / WSS**
   - TLS 1.3 による暗号化
   - 映像・音声・API 全てが暗号化される

3. **アプリ層 — トークン認証**
   - トークンを知らない人はログイン不可
   - セッション Cookie は 24 時間で自動失効
   - 5 回連続失敗で 5 分間ブロック（ブルートフォース対策）

### 推奨事項

- トークンは他人に教えないでください
- 定期的にトークンを変更することを推奨します（変更後はサービスの再起動が必要）
- Tailscale の共有機能でデバイスを追加する場合は、信頼できる人のみに限定してください
