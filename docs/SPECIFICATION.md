# Pet Camera System — 仕様書

## 1. プロジェクト概要

外出時に自宅のペットの様子をリアルタイムで確認するためのシステム。
Windows PC の内蔵カメラ（またはUSBカメラ）を常時稼働させ、スマートフォンやタブレットから安全に映像・音声を双方向でやり取りできるようにする。

### 1.1 基本方針

- **ローカルファースト**: 映像・音声配信サーバーは自宅PCで稼働させる（クラウドに映像を送らない）
- **セキュリティ多層防御**: Tailscale VPN + アプリケーション認証トークンの二層構成
- **シンプル**: 最小限の構成で確実に動作することを重視する
- **無料運用**: すべて無料枠の範囲で運用する

---

## 2. システム構成

```
┌──────────────────────────────────────────────────────────┐
│  自宅 Windows PC                                          │
│                                                            │
│  ┌───────────┐    ┌─────────────────────────────────┐    │
│  │  Webカメラ  │───▶│                                 │    │
│  └───────────┘    │  ストリーミングサーバー            │    │
│  ┌───────────┐    │  (Python + OpenCV + Flask)        │    │
│  │  マイク    │───▶│  Port: 5555                      │    │
│  └───────────┘    │                                   │    │
│  ┌───────────┐    │  映像: MJPEG over HTTPS           │    │
│  │  スピーカー │◀───│  音声: WSS (WebSocket Secure)     │    │
│  └───────────┘    │                                   │    │
│                    │  ┌────────────┐ ┌──────────────┐ │    │
│                    │  │ Web UI     │ │ Auth Token   │ │    │
│                    │  │ (HTML/JS)  │ │ Middleware   │ │    │
│                    │  └────────────┘ └──────────────┘ │    │
│                    └─────────────────────────────────┘    │
│                              │                             │
│  ┌───────────────────────────┼───────────────────────┐   │
│  │  Tailscale (VPN)          │                        │   │
│  │  100.x.x.x               │                        │   │
│  └───────────────────────────┼───────────────────────┘   │
└──────────────────────────────┼────────────────────────────┘
                               │ Tailscale 暗号化トンネル
                ┌──────────────┼──────────────┐
                │              │              │
          ┌─────┴─────┐ ┌─────┴─────┐ ┌─────┴─────┐
          │ スマホ(夫) │ │ スマホ(妻) │ │ タブレット │
          │ Tailscale  │ │ Tailscale  │ │ Tailscale  │
          │ + ブラウザ │ │ + ブラウザ │ │ + ブラウザ │
          │ 🎤⇄🔊     │ │ 🎤⇄🔊     │ │ 🎤⇄🔊     │
          └───────────┘ └───────────┘ └───────────┘

          映像: PC → クライアント（MJPEG over HTTPS 単方向）
          音声: PC ⇄ クライアント（WSS 双方向）
```

---

## 3. 技術スタック

| レイヤー | 技術 | 選定理由 |
|---------|------|---------|
| カメラ制御 | OpenCV (Python) | Windows のカメラを安定して制御でき、実績が豊富 |
| 音声入出力 | sounddevice (Python) | PortAudio バイナリ同梱。ビルド不要で Windows に容易に導入可能 |
| Web サーバー | Flask (Python) | 軽量で MJPEG ストリーミングとの相性が良い |
| WebSocket | Flask-SocketIO (`manage_session=False`) | Flask との統合が容易。音声の双方向リアルタイム通信に使用。Flask 3.1+ との互換性のため `manage_session=False` で初期化 |
| 映像配信 | MJPEG over HTTPS | ブラウザ互換性が高く、実装がシンプル |
| 音声配信 | WSS (WebSocket Secure, binary) | 低遅延の双方向音声ストリーミング。HTTPS と統一しMixed Content を回避 |
| フロントエンド | HTML + CSS + JavaScript (Vanilla) | フレームワーク不要。Web Audio API / getUserMedia を使用 |
| VPN | Tailscale | 無料（個人利用）、セットアップが簡単、WireGuard ベースで高速 |
| プロセス管理 | NSSM (Windows サービス化) | 異常終了時の自動再起動・ログ管理に対応 |

### 3.1 Render / Vercel / GitHub の活用

| サービス | 用途 |
|---------|------|
| GitHub | ソースコード管理 |
| Vercel | 将来的な通知用 Webhook エンドポイント（Phase 2） |
| Render | 将来的な通知サービスのホスティング（Phase 2） |

> **注意**: Phase 1（MVP）ではクラウドサービスへのデプロイは不要。すべてローカルで完結する。

---

## 4. 機能一覧

### Phase 1 — MVP（最小実用製品）

| # | 機能 | 説明 |
|---|------|------|
| F-01 | ライブ映像配信 | MJPEG ストリームでリアルタイム映像を配信 |
| F-02 | Web ビューワー | ブラウザでライブ映像を表示するレスポンシブ UI |
| F-03 | スナップショット取得 | 現在の映像を静止画（JPEG）としてダウンロード。サーバーには保存しない |
| F-04 | スナップショット保存 | 明示的に保存操作を行うとサーバーに JPEG を保存。保存上限 500MB、FIFO で古いものから自動削除 |
| F-05 | カメラ設定調整 | 解像度・フレームレート・明るさ・コントラストを UI から変更可能 |
| F-06 | Tailscale VPN 接続 | VPN 経由でのみアクセスを許可 |
| F-07 | アプリケーション認証 | トークンベースの認証。初回アクセス時にトークン入力を要求 |
| F-08 | 自動起動・自動復旧 | NSSM による Windows サービス化。異常終了時は自動再起動 |
| F-09 | ステータス表示 | 接続状態・稼働時間・FPS をヘッダーに表示 |
| F-10 | アクセスログ | 全リクエストをファイルに記録（日時・IP・エンドポイント・ステータスコード） |
| F-11 | 音声リスニング（家→外） | PC のマイクで家の音声を拾い、クライアントのスピーカーで再生 |
| F-12 | 音声トーク（外→家） | クライアントのマイクで声を拾い、PC のスピーカーから再生してペットに声を届ける |
| F-13 | パスキー認証（WebAuthn） | 初回トークン認証後、デバイスの生体認証（指紋・顔認証）を登録し、次回以降パスキーでログイン可能にする |

### Phase 2 — 拡張機能（将来）

| # | 機能 | 説明 |
|---|------|------|
| F-14 | 動体検知 | OpenCV の動体検知で動きを検出 |
| F-15 | プッシュ通知 | 動体検知時にスマホへ通知（Webhook 互換通知基盤を利用。実装時にサービスを選定） |
| F-16 | 録画 | 動体検知時に自動録画、手動録画にも対応 |
| F-17 | タイムラプス | 一日の様子をタイムラプス動画で確認 |
| F-18 | 暗視モード | 低照度環境での映像補正 |
| F-19 | 複数カメラ対応 | USB カメラ追加で多地点監視 |

---

## 5. 画面設計

### 5.1 メイン画面（ビューワー）

```
┌─────────────────────────────────────────────────┐
│  🐾 Pet Camera            ● LIVE   00:03:42     │  ← ヘッダー（ステータス表示）
├─────────────────────────────────────────────────┤
│                                                   │
│            ┌──────────────────────┐               │
│            │                      │               │
│            │    ライブ映像         │               │  ← メイン映像エリア
│            │    (MJPEG)           │               │
│            │                      │               │
│            └──────────────────────┘               │
│                                                   │
├─────────────────────────────────────────────────┤
│  [🔊 聞く ON/OFF]  [🎤 話す (押している間)]       │  ← 音声コントロール
│  音量: [━━━●━━━]                                 │
├─────────────────────────────────────────────────┤
│  [📷 スナップショット]  [💾 保存]  [⚙ 設定]      │  ← コントロールバー
└─────────────────────────────────────────────────┘
```

### 5.2 音声操作の仕様

| ボタン | 動作 | 説明 |
|--------|------|------|
| 🔊 聞く | トグル（ON/OFF） | ON にすると家の音声がスマホから流れる |
| 🎤 話す | プッシュ・トゥ・トーク（押している間だけ） | ボタンを押している間、スマホのマイク音声がPCスピーカーから再生される |
| 音量スライダー | ドラッグ | 受信音声（家の音）の再生音量を調整 |

> **プッシュ・トゥ・トークの理由**: 常時双方向にするとハウリング（エコー）のリスクがあるため、話す側は明示的に操作する方式とする。

### 5.3 設定パネル（オーバーレイ）

```
┌──────────────────────────┐
│  カメラ設定          [×] │
├──────────────────────────┤
│  解像度:  [1280x720 ▼]  │
│  FPS:     [15 ▼]        │
│  明るさ:  [━━━●━━━]     │
│  コントラスト: [━━●━━━━] │
│                          │
│       [適用]  [リセット] │
└──────────────────────────┘
```

### 5.4 認証画面

```
┌──────────────────────────┐
│  🐾 Pet Camera           │
├──────────────────────────┤
│                          │
│  アクセストークンを       │
│  入力してください         │
│                          │
│  [________________]      │
│                          │
│       [接続]             │
│                          │
│  ──── または ────        │
│                          │
│  [🔑 パスキーでログイン]  │ ← パスキー登録済みの場合のみ表示
│                          │
└──────────────────────────┘
```

### 5.5 レスポンシブ対応

- **デスクトップ**: 映像を最大表示
- **モバイル（主要ユースケース）**: 映像を画面幅にフィット、音声コントロール・操作ボタンは下部に固定

---

## 6. API 設計

### 6.1 エンドポイント一覧

ストリーミングサーバーが提供する HTTP エンドポイント:

| メソッド | パス | 認証 | 説明 |
|---------|------|------|------|
| GET | `/` | 不要 | 認証画面（トークン未検証時）/ Web ビューワー（検証済み時） |
| GET | `/video_feed` | 必要 | MJPEG ストリーム |
| GET | `/snapshot` | 必要 | 現在フレームを JPEG でダウンロード（サーバーに保存しない） |
| POST | `/api/snapshots` | 必要 | 現在フレームをサーバーに保存し、保存結果を返す |
| GET | `/api/snapshots` | 必要 | 保存済みスナップショット一覧を取得 |
| GET | `/api/snapshots/<filename>` | 必要 | 保存済みスナップショットを取得 |
| DELETE | `/api/snapshots/<filename>` | 必要 | 保存済みスナップショットを削除 |
| GET | `/api/status` | 必要 | サーバーステータス（JSON） |
| GET | `/api/settings` | 必要 | 現在のカメラ設定を取得 |
| PATCH | `/api/settings` | 必要 | カメラ設定を部分更新 |
| POST | `/api/auth` | 不要 | トークン検証。成功時にセッションCookieを発行（レート制限あり） |
| POST | `/api/logout` | 必要 | セッションを無効化し Cookie を削除 |
| POST | `/api/webauthn/register/options` | 必要 | WebAuthn 登録用チャレンジを生成 |
| POST | `/api/webauthn/register` | 必要 | WebAuthn クレデンシャルを検証・保存 |
| POST | `/api/webauthn/login/options` | 不要 | WebAuthn 認証用チャレンジを生成 |
| POST | `/api/webauthn/login` | 不要 | WebAuthn 認証レスポンスを検証し、成功時にセッションCookieを発行 |
| GET | `/api/webauthn/credentials` | 必要 | 登録済みパスキーの件数を取得 |

認証方式: リクエストヘッダー `Authorization: Bearer <token>` またはセッション Cookie。

#### セッション Cookie 仕様

| 属性 | 値 | 説明 |
|------|-----|------|
| Cookie名 | `pet_camera_session` | — |
| `HttpOnly` | `true` | JavaScript からのアクセスを禁止（XSS 対策） |
| `Secure` | `true` | HTTPS 接続時のみ送信 |
| `SameSite` | `Strict` | クロスサイトリクエストでは送信しない（CSRF 対策） |
| 有効期限 (TTL) | 24時間 | 発行から24時間後に自動失効。再ログインが必要 |
| パス | `/` | 全エンドポイントに適用 |

#### ログアウト・セッション無効化

| 操作 | 動作 |
|------|------|
| ブラウザを閉じる | Cookie は残るが、TTL 到達後に自動失効 |
| `POST /api/logout` | サーバー側でセッションを即座に無効化し、`Set-Cookie` で Cookie を削除 |
| トークン変更 | 環境変数 `PET_CAMERA_TOKEN` を変更してサーバー再起動すると、全既存セッションが無効化される |

### 6.2 WebSocket イベント（音声通信）

接続先: `wss://<マシン名>.<tailnet名>.ts.net:5555/audio`（SocketIO namespace）

> **注意**: `ws://`（非暗号化）は開発環境（localhost）でのみ使用可。本番運用では必ず `wss://` を使用すること。HTTPS ページから `ws://` への接続はブラウザの Mixed Content ポリシーによりブロックされる。

#### セッション管理

Flask-SocketIO は `manage_session=False` で初期化する。これにより Flask 標準のセッション管理を使用し、Flask 3.1+ の `RequestContext.session` プロパティ変更との互換性を確保する。Socket.IO ハンドラ内では Flask セッションの読み取りのみ行い、書き込みは行わない。

#### 認証

Socket.IO ハンドシェイク時に認証を必須とする。以下のいずれかで認証する:

1. **セッション Cookie**: HTTP API で認証済みの場合、ハンドシェイクに Cookie が自動付与される（推奨）
2. **Bearer トークン**: `auth` パラメータでトークンを送信する — `io({ auth: { token: "..." } })`

認証失敗時の動作:

| 状況 | サーバーの応答 |
|------|--------------|
| トークン/Cookie 未提供 | `connect_error` イベントを送信し即座に切断。`{"code": "AUTH_REQUIRED", "message": "Authentication required"}` |
| トークン/Cookie 無効 | `connect_error` イベントを送信し即座に切断。`{"code": "AUTH_INVALID", "message": "Invalid authentication"}` |

#### イベント一覧

| イベント名 | 方向 | ペイロード | 説明 |
|-----------|------|-----------|------|
| `audio_stream` | サーバー → クライアント | `binary (PCM 16bit, 16kHz, mono)` | 家の音声データ（マイク入力） |
| `audio_talk` | クライアント → サーバー | `binary (PCM 16bit, 16kHz, mono)` | ユーザーの声のデータ（スピーカー出力） |
| `audio_listen_start` | クライアント → サーバー | なし | 音声リスニング開始を要求 |
| `audio_listen_stop` | クライアント → サーバー | なし | 音声リスニング停止を要求 |
| `audio_talk_start` | クライアント → サーバー | なし | トークスロットの取得を要求 |
| `audio_talk_stop` | クライアント → サーバー | なし | トークスロットの解放 |
| `audio_status` | サーバー → クライアント | `{"listening": bool, "talking": bool}` | 音声状態の通知 |

音声フォーマット:
- サンプルレート: 16,000 Hz
- ビット深度: 16bit（リトルエンディアン）
- チャンネル数: モノラル（1ch）
- チャンクサイズ: 1024 サンプル（64ms/チャンク）

### 6.3 レスポンス・エラー仕様

#### 共通エラー形式

すべてのエラーレスポンスは以下の JSON 形式で返す:

```json
{
  "error": {
    "code": "INVALID_PARAMETER",
    "message": "brightness must be between 0 and 100"
  }
}
```

#### HTTP ステータスコード

| コード | 用途 |
|--------|------|
| 200 | 成功 |
| 400 | リクエスト不正（バリデーションエラー、不明なパラメータ） |
| 401 | 認証トークン未提供・無効 |
| 429 | レート制限超過（認証試行回数の上限到達） |
| 404 | リソース未検出（存在しないスナップショット等） |
| 500 | サーバー内部エラー（カメラ異常等） |

#### エラーコード一覧

| コード | 説明 |
|--------|------|
| `AUTH_REQUIRED` | 認証トークンが未提供 |
| `AUTH_INVALID` | 認証トークンが無効 |
| `RATE_LIMITED` | 認証試行回数の上限超過（IP単位で一時ブロック中） |
| `INVALID_PARAMETER` | パラメータの値が許容範囲外 |
| `UNKNOWN_PARAMETER` | 未定義のパラメータが送信された |
| `CAMERA_ERROR` | カメラの接続・取得に失敗 |
| `STORAGE_ERROR` | スナップショットの保存・読込に失敗 |
| `NOT_FOUND` | 指定されたリソースが存在しない |

### 6.4 レスポンス例

#### POST `/api/auth`

リクエスト:
```json
{
  "token": "my-secret-token"
}
```

成功レスポンス (200):
```json
{
  "authenticated": true
}
```

失敗レスポンス (401):
```json
{
  "error": {
    "code": "AUTH_INVALID",
    "message": "Invalid token"
  }
}
```

レート制限超過レスポンス (429):
```json
{
  "error": {
    "code": "RATE_LIMITED",
    "message": "Too many authentication attempts. Try again in 300 seconds.",
    "retry_after_seconds": 300
  }
}
```

#### `/api/auth` レート制限仕様

| 項目 | 仕様 |
|------|------|
| 制限単位 | クライアント IP アドレスごと |
| 許容回数 | 5回 / 5分間 |
| 超過時の動作 | HTTP 429 を返し、該当 IP からの認証試行を 5分間ブロック |
| カウント対象 | 失敗した認証試行のみ（成功時はカウントリセット） |
| 監査ログ | 連続3回失敗時にログレベル WARNING で記録。5回到達（ブロック発動）時に ERROR で記録 |

#### GET `/api/status`

```json
{
  "status": "running",
  "uptime_seconds": 3842,
  "fps": 14.8,
  "resolution": "1280x720",
  "clients_connected": 1,
  "camera_index": 0,
  "audio": {
    "microphone_active": true,
    "speaker_active": false,
    "listening_clients": 1
  }
}
```

#### GET `/api/settings`

```json
{
  "resolution": {
    "width": 1280,
    "height": 720
  },
  "fps": 15,
  "brightness": 50,
  "contrast": 50
}
```

#### PATCH `/api/settings`

部分更新をサポートする。送信されたフィールドのみ更新する。

リクエスト（例: 明るさだけ変更）:
```json
{
  "brightness": 70
}
```

成功レスポンス (200): 更新後の全設定を返す:
```json
{
  "resolution": {
    "width": 1280,
    "height": 720
  },
  "fps": 15,
  "brightness": 70,
  "contrast": 50
}
```

#### パラメータ制約

| パラメータ | 型 | 許容値 | デフォルト |
|-----------|-----|--------|-----------|
| `resolution.width` | int | 640, 1280, 1920 | 1280 |
| `resolution.height` | int | 480, 720, 1080 | 720 |
| `fps` | int | 5, 10, 15, 30 | 15 |
| `brightness` | int | 0〜100 | 50 |
| `contrast` | int | 0〜100 | 50 |

> `resolution` は `width` と `height` を必ずセットで送信すること。許容される組み合わせは `640x480`, `1280x720`, `1920x1080` のみ。

#### POST `/api/snapshots`

リクエストボディ: なし

成功レスポンス (200):
```json
{
  "filename": "snapshot_20260219_143052_123.jpg",
  "size_bytes": 85432,
  "timestamp": "2026-02-19T14:30:52+09:00",
  "storage_used_bytes": 12345678,
  "storage_limit_bytes": 524288000
}
```

#### GET `/api/snapshots`

```json
{
  "snapshots": [
    {
      "filename": "snapshot_20260219_143052_123.jpg",
      "size_bytes": 85432,
      "timestamp": "2026-02-19T14:30:52+09:00"
    }
  ],
  "total_count": 1,
  "storage_used_bytes": 85432,
  "storage_limit_bytes": 524288000
}
```

### 6.5 スナップショット保存仕様

| 項目 | 仕様 |
|------|------|
| 保存先 | `snapshots/` ディレクトリ |
| ファイル命名 | `snapshot_YYYYMMDD_HHmmss_fff.jpg`（サーバー時刻） |
| 保存上限 | 500 MB |
| 削除ポリシー | FIFO（保存上限超過時に最も古いファイルから自動削除） |
| 保存タイミング | `POST /api/snapshots` 呼び出し時のみ（自動保存はしない） |

---

## 7. ディレクトリ構成

```
pet-camera/
├── docs/
│   ├── SPECIFICATION.md        # 本仕様書
│   └── REVIEW_SPCIFICATION.md  # レビュー結果
├── server/
│   ├── app.py                  # Flask アプリケーション（エントリーポイント）
│   ├── camera.py               # カメラ制御モジュール
│   ├── audio.py                # 音声入出力モジュール（マイク・スピーカー制御）
│   ├── auth.py                 # 認証ミドルウェア
│   ├── webauthn_auth.py        # WebAuthn（パスキー）登録・認証モジュール
│   ├── config.py               # 設定管理
│   └── requirements.txt        # Python 依存パッケージ
├── data/
│   └── webauthn_credentials.json  # WebAuthn クレデンシャル保存（.gitignore対象）
├── static/
│   ├── css/
│   │   └── style.css           # スタイルシート
│   ├── js/
│   │   ├── app.js              # フロントエンドロジック（映像・UI）
│   │   └── audio.js            # 音声制御（Web Audio API / getUserMedia）
│   └── img/
│       └── favicon.ico         # ファビコン
├── templates/
│   ├── index.html              # メインページテンプレート
│   └── login.html              # 認証ページテンプレート
├── certs/                      # TLS証明書・秘密鍵（.gitignore対象）
├── logs/                       # アクセスログ・アプリログ（.gitignore対象）
├── snapshots/                  # スナップショット保存先（.gitignore対象）
├── .gitignore
├── README.md
├── setup.bat                   # 初期セットアップスクリプト
├── install-service.bat         # NSSM サービス登録スクリプト
└── renew-cert.bat              # TLS証明書更新スクリプト（タスクスケジューラ登録用）
```

---

## 8. セキュリティ設計

### 8.1 多層防御アーキテクチャ

```
第1層: Tailscale VPN
  インターネット ──×──▶ 自宅PC:5555    ← ポート開放しない、外部から到達不可
  Tailscale VPN  ──✓──▶ 100.x.x.x:5555 ← VPN 内部アドレスでのみアクセス可

第2層: アプリケーション認証トークン
  トークン未提供 ──×──▶ API/ストリーム  ← 401 Unauthorized
  正しいトークン ──✓──▶ API/ストリーム  ← アクセス許可
```

### 8.2 ネットワークセキュリティ（Tailscale VPN）

- **ゼロトラスト**: Tailscale はデバイス単位で認証。承認されたデバイスのみ接続可能
- **暗号化**: WireGuard プロトコルによるエンドツーエンド暗号化
- **ポート非公開**: ルーターでのポートフォワーディング一切不要
- **デバイス管理**: Tailscale 管理画面で接続デバイスを管理・取り消し可能

### 8.3 パスキー認証（WebAuthn / FIDO2）

#### 概要

初回トークン認証後、デバイスの生体認証（指紋認証・顔認証）を登録すると、次回以降はトークン入力不要でパスキーのみでログインできる。

#### 認証フロー

```
【パスキー登録（初回のみ）】
1. トークンでログイン → メイン画面の設定パネルを開く
2. 「このデバイスを登録」ボタンをタップ
3. サーバーが登録チャレンジを生成 (POST /api/webauthn/register/options)
4. ブラウザが生体認証をリクエスト → ユーザーが指紋/顔で認証
5. 公開鍵クレデンシャルをサーバーに送信 (POST /api/webauthn/register)
6. サーバーが検証し、公開鍵を data/webauthn_credentials.json に保存

【パスキーログイン（2回目以降）】
1. ログイン画面で「パスキーでログイン」ボタンをタップ
2. サーバーが認証チャレンジを生成 (POST /api/webauthn/login/options)
3. ブラウザが生体認証をリクエスト → ユーザーが指紋/顔で認証
4. 署名をサーバーに送信 (POST /api/webauthn/login)
5. サーバーが公開鍵で署名を検証 → セッション Cookie 発行
```

#### 技術仕様

| 項目 | 仕様 |
|------|------|
| プロトコル | WebAuthn Level 2 (W3C 標準) |
| サーバーライブラリ | py-webauthn >= 2.0 |
| Relying Party ID | TLS 証明書のドメイン名（例: `lenovo411.tail499884.ts.net`） |
| ユーザー検証 | required（生体認証必須） |
| Resident Key | preferred |
| クレデンシャル保存 | `data/webauthn_credentials.json`（サーバーローカル） |
| 対応ブラウザ | Chrome (Android), Safari (iOS) の最新版 |

#### セキュリティ特性

- **生体情報はサーバーに送信されない**: デバイス内で照合し、暗号署名のみが送信される
- **デバイスごとに登録が必要**: 他人のデバイスでは使用不可
- **トークン認証は常にフォールバックとして利用可能**: 新しいデバイス追加やパスキー非対応環境向け

### 8.4 アプリケーションセキュリティ

| 対策 | 説明 |
|------|------|
| トークン認証 | 環境変数 `PET_CAMERA_TOKEN` に設定した文字列で認証。初回アクセス時にブラウザで入力し、セッション Cookie を発行 |
| パスキー認証 | WebAuthn による生体認証。初回トークン認証後にデバイスを登録し、次回以降パスキーでログイン |
| バインドアドレス制限 | Flask サーバーを Tailscale の仮想IPアドレス（`100.x.x.x`）にのみバインド |
| アクセスログ | 全リクエストをログファイルに記録（日時・クライアントIP・メソッド・パス・ステータスコード） |
| CORS 制限 | 同一オリジンのみ許可 |
| 入力バリデーション | 設定変更 API のパラメータを許容値テーブル（6.4節）に基づき検証 |
| ディレクトリトラバーサル防止 | スナップショットのファイル名をサニタイズ。`snapshots/` 以外のパスを拒否 |

### 8.5 アクセスログ形式

```
2026-02-19T14:30:52+09:00 | 100.100.1.51 | GET /video_feed | 200
2026-02-19T14:30:55+09:00 | 100.100.1.51 | POST /api/snapshots | 200
2026-02-19T14:31:00+09:00 | 100.100.1.99 | GET /api/status | 401
```

- 保存先: `logs/access.log`
- ローテーション: 日次ローテーション、7日分保持

### 8.6 アクセス手順

1. 自宅PCに Tailscale をインストール・ログイン
2. スマートフォン（夫・妻）に Tailscale アプリをインストール・同一アカウントでログイン
3. スマホのブラウザから `http://100.x.x.x:5555` にアクセス
4. 認証トークンを入力してログイン
5. → Tailscale 未接続 または トークン未認証 のデバイスからは一切アクセスできない

---

## 9. 非機能要件

| 項目 | 要件 | 測定条件 |
|------|------|---------|
| 映像レイテンシ | 1秒以内（LAN内）、3秒以内（モバイル回線経由VPN） | クライアント2台同時接続、720p/15fps、5分間の平均値で評価 |
| 音声レイテンシ | 500ms以内（LAN内）、1秒以内（モバイル回線経由VPN） | クライアント1台がリスニング中、5分間の平均値で評価 |
| 解像度 | 720p（1280×720）をデフォルトとする | — |
| フレームレート | 15fps をデフォルトとする（帯域節約） | — |
| 同時接続数 | 2〜3クライアントを想定 | — |
| CPU使用率 | アイドル時: 5%以下、映像配信時: 20%以下、映像+音声配信時: 30%以下 | 2クライアント同時接続・720p/15fps・音声ON、5分間の平均値で評価 |
| ストレージ | スナップショット保存: 最大 500MB（FIFO自動削除） | — |
| 可用性 | PC 起動中は常時稼働。異常終了時は自動再起動（NSSM） | — |
| ログ保持 | アクセスログ: 日次ローテーション、7日分保持 | — |
| ブラウザ対応 | Chrome, Safari (iOS), Edge の最新版 | — |

### 9.1 参考計測環境

上記の測定は以下の環境を想定する:

- **PC**: Windows 11、Intel Core i5 相当以上、RAM 8GB 以上
- **ネットワーク**: 自宅回線 100Mbps 以上、モバイル 4G/5G
- **カメラ**: 720p 対応 USB カメラまたは内蔵カメラ

---

## 10. 可用性・運用設計

### 10.1 プロセス管理（NSSM）

タスクスケジューラではなく NSSM（Non-Sucking Service Manager）で Windows サービスとして登録し、以下を実現する:

| 項目 | 設定 |
|------|------|
| サービス名 | `PetCameraServer` |
| 起動種別 | 自動（PC起動時に自動開始） |
| 異常終了時 | 自動再起動（5秒後にリトライ） |
| 再起動上限 | 3回/10分（上限到達後は停止してログに記録） |
| 標準出力ログ | `logs/stdout.log` |
| 標準エラーログ | `logs/stderr.log` |
| ログローテーション | NSSM のファイルローテーション設定で 10MB 上限 |

### 10.2 ヘルスチェック

- サーバー起動後、カメラが接続されていない場合はログにエラーを出力して待機（クラッシュせずリトライ可能にする）
- `/api/status` エンドポイントで稼働状況を随時確認可能

---

## 11. 双方向音声の技術設計

### 11.1 音声フロー

```
【リスニング（家の音 → スマホ）】
PCマイク → sounddevice入力(16kHz) → PCMチャンク → SocketIO → リサンプリング(→48kHz) → WebAudio API → スマホスピーカー

【トーク（スマホの声 → 家）】
スマホマイク → getUserMedia → ScriptProcessor(48kHz) → リサンプリング(→16kHz) → PCMチャンク → SocketIO → sounddevice出力(16kHz) → PCスピーカー
```

> **リサンプリング**: ブラウザの AudioContext は通常 44.1kHz または 48kHz で動作し、16kHz をサポートしないことが多い。クライアント側でリニア補間によるリサンプリングを行い、サーバーとの 16kHz PCM フォーマットに変換する。

### 11.2 設計上の考慮

| 課題 | 対策 |
|------|------|
| ハウリング（エコー） | プッシュ・トゥ・トーク方式で送話と受話を分離 |
| 音声遅延 | チャンクサイズを 1024 サンプル（64ms）に設定し低遅延化 |
| 帯域使用量 | 16kHz/16bit/mono = 約 256kbps（映像と合わせても十分実用的） |
| ブラウザ制限 | getUserMedia は HTTPS または localhost でのみ利用可。Tailscale の IP 直指定は HTTP だが、ブラウザの `chrome://flags` 等で例外設定するか、自己署名証明書を導入 |
| 複数クライアント | リスニングは全クライアントに同時配信。トークは先勝ち（1クライアントのみ同時トーク可） |

### 11.3 ブラウザ音声許可への対応

`getUserMedia`（マイクアクセス）はセキュアコンテキスト（HTTPS / localhost）で動作する。Tailscale IP アドレスへの HTTP 接続では制限される場合がある。対応方針:

1. **本番（必須）**: Tailscale の MagicDNS + HTTPS 証明書機能（`tailscale cert`）を利用し、`https://<マシン名>.<tailnet名>.ts.net:5555` でアクセスする
2. **開発環境のみ**: `http://localhost:5555` でアクセスする（localhost はセキュアコンテキストとして扱われる）

### 11.4 HTTPS / TLS 実装詳細

#### TLS 終端方式

Flask に直接 SSL コンテキストを設定し、TLS を終端する（リバースプロキシは使用しない）。

```python
# app.py での TLS 設定例
ssl_context = (
    "certs/<マシン名>.<tailnet名>.ts.net.crt",
    "certs/<マシン名>.<tailnet名>.ts.net.key"
)
socketio.run(app, host="0.0.0.0", port=5555, ssl_context=ssl_context)
```

> Flask-SocketIO は `ssl_context` を指定すると HTTPS + WSS を同一ポートで同時に提供する。映像（MJPEG）・音声（WSS）・API（HTTPS）のすべてが `:5555` に統一される。

#### 証明書配置

| ファイル | 配置先 | 説明 |
|---------|--------|------|
| `<マシン名>.<tailnet名>.ts.net.crt` | `certs/` | TLS 証明書 |
| `<マシン名>.<tailnet名>.ts.net.key` | `certs/` | 秘密鍵 |

- `certs/` ディレクトリは `.gitignore` に追加する
- 秘密鍵のファイル権限は所有者のみ読み取り可に設定

#### 証明書の更新運用

| 項目 | 仕様 |
|------|------|
| 証明書の有効期限 | Tailscale 発行証明書は 90日間有効 |
| 更新方法 | `tailscale cert <マシン名>.<tailnet名>.ts.net` を再実行 |
| 更新後の反映 | サービス再起動が必要（`nssm restart PetCameraServer`） |
| 更新の自動化 | タスクスケジューラで月1回 `tailscale cert` を実行し、サービスを再起動するバッチを登録 |

#### 開発環境と本番環境の切り分け

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| プロトコル | HTTP + WS | HTTPS + WSS |
| ホスト | `localhost` / `127.0.0.1` | Tailscale IP / MagicDNS |
| TLS 証明書 | 不要 | 必須（`tailscale cert`） |
| マイク機能 | localhost なら動作可 | HTTPS 必須 |
| 設定方法 | 環境変数 `PET_CAMERA_ENV=development` | 環境変数 `PET_CAMERA_ENV=production`（デフォルト） |

---

## 12. 開発フェーズ・実装順序

### Phase 1: MVP（本プロジェクトのスコープ）

```
Step 1: プロジェクト初期化
  - Git リポジトリ作成
  - Python 仮想環境セットアップ
  - 依存パッケージインストール

Step 2: 認証モジュール (auth.py)
  - トークン検証ミドルウェア
  - セッション Cookie 発行
  - アクセスログ記録

Step 3: カメラ制御モジュール (camera.py)
  - OpenCV でカメラ接続
  - フレーム取得ループ
  - 設定変更機能（解像度・FPS・明るさ・コントラスト）

Step 4: 音声モジュール (audio.py)
  - PyAudio でマイク入力キャプチャ
  - PyAudio でスピーカー出力再生
  - チャンク管理

Step 5: ストリーミングサーバー (app.py)
  - Flask + Flask-SocketIO サーバー構築
  - MJPEG ストリーミングエンドポイント
  - スナップショット取得・保存 API
  - ステータス API
  - 設定変更 API（PATCH、バリデーション付き）
  - WebSocket 音声ストリーミング

Step 6: Web UI (templates/ + static/)
  - 認証画面
  - レスポンシブビューワー
  - 音声コントロール（聞く・話す・音量）
  - コントロール（スナップショット・設定）
  - ステータス表示

Step 7: セキュリティ設定
  - Tailscale インストール・設定
  - HTTPS 設定（MagicDNS + tailscale cert）
  - バインドアドレス制限
  - 接続テスト

Step 8: サービス化・運用設定
  - NSSM インストール・サービス登録 (install-service.bat)
  - ログローテーション設定
  - 初期セットアップスクリプト (setup.bat)
```

### Phase 2: 拡張（将来）

- 動体検知 + Webhook 互換通知
- 録画機能
- タイムラプス

---

## 13. 依存パッケージ

### Python (requirements.txt)

```
opencv-python>=4.8.0
flask>=3.0.0
flask-socketio>=5.3.0
sounddevice>=0.4.6
numpy>=1.24.0
python-engineio>=4.8.0
webauthn>=2.0.0
```

### システム要件

- Python 3.10 以上
- Windows 10/11
- USB カメラまたは内蔵カメラ
- マイク（内蔵または USB / ヘッドセット）
- スピーカー（内蔵または USB / ヘッドセット）
- Tailscale クライアント
- NSSM（Non-Sucking Service Manager）

---

## 14. Tailscale セットアップ手順（参考）

1. https://tailscale.com/ でアカウント作成（無料）
2. Windows PC に Tailscale をインストール → 割り当てられた IP を確認（例: `100.100.1.50`）
3. MagicDNS を有効化し、`tailscale cert` で HTTPS 証明書を取得
4. スマートフォンに Tailscale アプリをインストール
5. 同一アカウントでログイン（妻のデバイスは「デバイス共有」機能で追加）
6. Flask サーバーの `HOST` 設定を Tailscale IP に設定
7. スマホのブラウザから `https://[マシン名].tailnet-name.ts.net:5555` でアクセス確認

---

## 15. 制約・前提条件

- 自宅PCは外出中も**電源ON・スリープ無効**にしておく必要がある
- Tailscale の無料プランはデバイス100台まで（本用途では十分）
- MJPEG は H.264 等と比べて帯域効率は劣るが、実装のシンプルさを優先
- 音声はプッシュ・トゥ・トーク方式とし、常時双方向通話は Phase 1 ではサポートしない
- 音声品質は電話相当（16kHz/mono）。高音質ステレオ音声は Phase 1 のスコープ外
