<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¡DNG Camera - Login</title>
  <meta name="description" content="è‡ªå®…ã®ãƒšãƒƒãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¦‹å®ˆã‚‹ã‚«ãƒ¡ãƒ©ã‚·ã‚¹ãƒ†ãƒ ">
  <meta name="theme-color" content="#0f1117">
  <meta name="mobile-web-app-capable" content="yes">
  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DNGCam">
  <link rel="apple-touch-icon" href="/static/img/apple-touch-icon.png">
  <!-- PWA Manifest & Icons -->
  <link rel="manifest" href="/static/manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/img/icon-192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/img/favicon.png">
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class="login-page">
  <div class="login-card">
    <h1>ğŸ¡DNG Camera</h1>
    <p>ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
    <form id="login-form">
      <input type="password" id="token-input" placeholder="ãƒˆãƒ¼ã‚¯ãƒ³" autocomplete="off" required>
      <button type="submit" id="login-btn">æ¥ç¶š</button>
      <p id="login-error" class="error" hidden></p>
    </form>
    <div id="passkey-section" hidden>
      <div class="divider"><span>ã¾ãŸã¯</span></div>
      <button id="btn-passkey-login" class="btn-passkey" type="button">
        &#x1F511; ãƒ‘ã‚¹ã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
      </button>
    </div>
  </div>
  <a href="#" id="terms-link" class="terms-link">åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>

  <!-- Terms / Privacy modal -->
  <div id="terms-overlay" class="terms-overlay" hidden>
    <div class="terms-dialog">
      <div class="terms-header">
        <span>åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</span>
        <button id="terms-close" class="terms-close-btn" type="button">&times;</button>
      </div>
      <div class="terms-body">
        <h3>æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦</h3>
        <p>ã€ŒDNG Cameraã€ï¼ˆä»¥ä¸‹ã€Œæœ¬ã‚¢ãƒ—ãƒªã€ï¼‰ã¯ã€å€‹äººãŒé–‹ç™ºãƒ»é‹å–¶ã™ã‚‹éå–¶åˆ©ã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ ãƒšãƒƒãƒˆè¦‹å®ˆã‚Šã‚¢ãƒ—ãƒªã§ã™ã€‚</p>
        <p>æœ¬ã‚¢ãƒ—ãƒªã¯ç„¡ä¿è¨¼ï¼ˆAS-ISï¼‰ã§æä¾›ã•ã‚Œã¦ãŠã‚Šã€é–‹ç™ºè€…ã¯æœ¬ã‚¢ãƒ—ãƒªã®åˆ©ç”¨ã«ã‚ˆã£ã¦ç”Ÿã˜ãŸã„ã‹ãªã‚‹æå®³ã«ã¤ã„ã¦ã‚‚è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</p>

        <h3>å…è²¬äº‹é …</h3>
        <ul>
          <li>æ˜ åƒã®é€å—ä¿¡ã¯Tailscale VPNåŠã³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆç’°å¢ƒã«ä¾å­˜ã—ã¦ãŠã‚Šã€æ¥ç¶šã®å®‰å®šæ€§ãƒ»å“è³ªã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
          <li>Tailscaleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç®¡ç†åŠã³Tailscaleã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</li>
          <li>ã‚µãƒ¼ãƒ“ã‚¹ã®ç¶™ç¶šæ€§ã€å¯ç”¨æ€§ã«ã¤ã„ã¦ä¿è¨¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
          <li>äºˆå‘Šãªãã‚µãƒ¼ãƒ“ã‚¹ã‚’å¤‰æ›´ãƒ»çµ‚äº†ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</li>
        </ul>

        <h3>ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šæ‰±ã„</h3>
        <p>æœ¬ã‚¢ãƒ—ãƒªã¯å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã¸ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã›ã‚“ã€‚ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚µãƒ¼ãƒãƒ¼ï¼ˆè¦ªæ©ŸPCï¼‰å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
        <p>ä¿å­˜ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ï¼š</p>
        <ul>
          <li>ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆç”»åƒï¼ˆè¦ªæ©ŸPCã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯ã«ä¿å­˜ã€ä¸Šé™500MBã§å¤ã„ã‚‚ã®ã‹ã‚‰è‡ªå‹•å‰Šé™¤ï¼‰</li>
          <li>ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ï¼ˆæ¥ç¶šå…ƒIPã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ»æ—¥æ™‚ãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã€7æ—¥é–“ä¿æŒï¼‰</li>
          <li>WebAuthnèªè¨¼æƒ…å ±ï¼ˆå…¬é–‹éµã®ã¿ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç­‰ã®å€‹äººæƒ…å ±ã¯å«ã¿ã¾ã›ã‚“ï¼‰</li>
          <li>ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ï¼ˆãƒ¡ãƒ¢ãƒªä¸Šã®ã¿ã€ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ã§æ¶ˆå»ï¼‰</li>
        </ul>
        <p>æœ¬ã‚¢ãƒ—ãƒªã¸ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ã¯ä¸è¦ã§ã™ã€‚æ˜ åƒãƒ»éŸ³å£°ã¯Tailscale VPNã«ã‚ˆã‚‹æš—å·åŒ–é€šä¿¡ã§é€å—ä¿¡ã•ã‚Œã¾ã™ã€‚</p>

        <h3>ç¦æ­¢äº‹é …</h3>
        <ul>
          <li>æœ¬ã‚¢ãƒ—ãƒªã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹</li>
          <li>æœ¬ã‚¢ãƒ—ãƒªã®æ©Ÿèƒ½ã‚’æ‚ªç”¨ã—ãŸè¡Œç‚º</li>
          <li>ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ©ç”¨ã‚’å¦¨å®³ã™ã‚‹è¡Œç‚º</li>
        </ul>

        <h3>ãŠå•ã„åˆã‚ã›</h3>
        <p>æœ¬ã‚¢ãƒ—ãƒªã«é–¢ã™ã‚‹ãŠå•ã„åˆã‚ã›ã¯ã€é–‹ç™ºè€…ã«ç›´æ¥ã”é€£çµ¡ãã ã•ã„ã€‚</p>
      </div>
    </div>
  </div>

  <style>
    .divider {
      display: flex; align-items: center; gap: 0.5rem;
      margin: 1rem 0; color: var(--text-muted); font-size: 0.85rem;
    }
    .divider::before, .divider::after {
      content: ''; flex: 1; height: 1px; background: var(--border);
    }
    .btn-passkey {
      width: 100%; padding: 0.75rem; border: 1px solid var(--accent);
      border-radius: 8px; background: transparent; color: var(--accent);
      font-size: 1rem; cursor: pointer;
    }
    .btn-passkey:hover { background: var(--accent); color: #fff; }
    .btn-passkey:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
  <script>
    // --- Token login ---
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const token = document.getElementById('token-input').value;
      const errorEl = document.getElementById('login-error');
      const btn = document.getElementById('login-btn');
      errorEl.hidden = true;
      btn.disabled = true;
      btn.textContent = 'æ¥ç¶šä¸­...';
      try {
        const res = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token }),
        });
        const data = await res.json();
        if (res.ok) {
          window.location.reload();
        } else {
          errorEl.textContent = data.error?.message || 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ';
          errorEl.hidden = false;
        }
      } catch (err) {
        errorEl.textContent = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼';
        errorEl.hidden = false;
      } finally {
        btn.disabled = false;
        btn.textContent = 'æ¥ç¶š';
      }
    });

    // --- Passkey (WebAuthn) login ---
    const passkeySection = document.getElementById('passkey-section');
    const btnPasskey = document.getElementById('btn-passkey-login');

    // Helper: base64url encode/decode
    function b64urlToBytes(b64url) {
      const b64 = b64url.replace(/-/g, '+').replace(/_/g, '/');
      const pad = (4 - b64.length % 4) % 4;
      const raw = atob(b64 + '='.repeat(pad));
      return Uint8Array.from(raw, c => c.charCodeAt(0));
    }
    function bytesToB64url(bytes) {
      const arr = new Uint8Array(bytes);
      let binary = '';
      for (let i = 0; i < arr.length; i++) binary += String.fromCharCode(arr[i]);
      return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    // Check if passkeys are available
    async function checkPasskeys() {
      if (!window.PublicKeyCredential) return;
      try {
        const res = await fetch('/api/webauthn/login/options', { method: 'POST' });
        if (res.ok) passkeySection.hidden = false;
      } catch (e) { /* ignore */ }
    }
    checkPasskeys();

    // --- Terms modal ---
    const termsLink = document.getElementById('terms-link');
    const termsOverlay = document.getElementById('terms-overlay');
    const termsClose = document.getElementById('terms-close');
    termsLink.addEventListener('click', (e) => {
      e.preventDefault();
      termsOverlay.hidden = false;
    });
    termsClose.addEventListener('click', () => { termsOverlay.hidden = true; });
    termsOverlay.addEventListener('click', (e) => {
      if (e.target === termsOverlay) termsOverlay.hidden = true;
    });

    btnPasskey.addEventListener('click', async () => {
      const errorEl = document.getElementById('login-error');
      errorEl.hidden = true;
      btnPasskey.disabled = true;
      btnPasskey.textContent = 'èªè¨¼ä¸­...';

      try {
        // Get authentication options
        const optRes = await fetch('/api/webauthn/login/options', { method: 'POST' });
        if (!optRes.ok) throw new Error('ãƒ‘ã‚¹ã‚­ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        const options = await optRes.json();

        // Decode challenge and allowCredentials
        options.challenge = b64urlToBytes(options.challenge);
        if (options.allowCredentials) {
          options.allowCredentials = options.allowCredentials.map(c => ({
            ...c, id: b64urlToBytes(c.id),
          }));
        }

        // Invoke browser authenticator
        const assertion = await navigator.credentials.get({ publicKey: options });

        // Encode response
        const body = {
          id: assertion.id,
          rawId: bytesToB64url(assertion.rawId),
          type: assertion.type,
          response: {
            authenticatorData: bytesToB64url(assertion.response.authenticatorData),
            clientDataJSON: bytesToB64url(assertion.response.clientDataJSON),
            signature: bytesToB64url(assertion.response.signature),
            userHandle: assertion.response.userHandle
              ? bytesToB64url(assertion.response.userHandle) : null,
          },
        };

        // Verify on server
        const verifyRes = await fetch('/api/webauthn/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        if (verifyRes.ok) {
          window.location.reload();
        } else {
          const data = await verifyRes.json();
          errorEl.textContent = data.error?.message || 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ';
          errorEl.hidden = false;
        }
      } catch (err) {
        if (err.name !== 'NotAllowedError') {
          errorEl.textContent = err.message || 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ';
          errorEl.hidden = false;
        }
      } finally {
        btnPasskey.disabled = false;
        btnPasskey.textContent = '\u{1F511} ãƒ‘ã‚¹ã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³';
      }
    });
  </script>
</body>
</html>
