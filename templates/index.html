<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Pet Camera</title>
  <meta name="description" content="自宅のペットをリアルタイムで見守るカメラシステム">
  <meta name="theme-color" content="#0f1117">
  <meta name="mobile-web-app-capable" content="yes">
  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Pet Camera">
  <link rel="apple-touch-icon" href="/static/img/apple-touch-icon.png">
  <!-- PWA Manifest & Icons -->
  <link rel="manifest" href="/static/manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/img/icon-192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/img/favicon.png">
  <link rel="stylesheet" href="/static/css/style.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <!-- Header -->
  <header id="header">
    <div class="header-left">
      <span class="logo">Pet Camera</span>
    </div>
    <div class="header-center">
      <button id="btn-reload" class="btn-reload" title="画面更新">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        <span class="btn-reload-text">画面更新</span>
      </button>
    </div>
    <div class="header-right">
      <span id="live-badge" class="badge">LIVE</span>
      <span id="uptime">00:00:00</span>
    </div>
  </header>

  <!-- Video -->
  <main>
    <div class="video-container">
      <video id="video-stream-webrtc" autoplay playsinline muted hidden></video>
      <img id="video-stream-mjpeg" src="/video_feed" alt="Live Feed">
      <div id="video-overlay" class="overlay" hidden>
        <p>カメラに接続中...</p>
      </div>
      <!-- PiP: self-preview during "顔を見せる" -->
      <div id="owner-pip" class="owner-pip" hidden>
        <video id="owner-pip-video" playsinline muted></video>
      </div>
    </div>

    <!-- Exclusive session banner (shown when another device is using features) -->
    <div id="exclusive-banner" class="exclusive-banner" hidden>
      他のデバイスが操作中のため、操作できません
    </div>

    <!-- Controls toggle button -->
    <button id="controls-toggle" class="controls-toggle" title="操作パネル表示/非表示">
      <span id="controls-toggle-icon">&#x25B2;</span>
    </button>

    <!-- Controls panel (hideable) -->
    <div id="controls-panel">
      <!-- Row 1: Audio + Face + Volume -->
      <div class="controls">
        <button id="btn-listen" class="btn" title="家の音を聞く">
          <span class="icon">&#x1F50A;</span> 聞く
        </button>
        <button id="btn-talk" class="btn" title="押している間話す">
          <span class="icon">&#x1F3A4;</span> 話す
        </button>
        <button id="btn-show-face" class="btn" title="フロントカメラ映像を送信">
          <span class="icon">&#x1F4F9;</span> 顔を見せる
        </button>
        <span id="owner-video-status" class="status-text"></span>
        <label class="volume-control">
          <span>音量</span>
          <input type="range" id="volume-slider" min="0" max="100" value="80">
        </label>
      </div>

      <!-- Row 2: Save + Settings -->
      <div class="controls">
        <button id="btn-snapshot" class="btn" title="スマホにダウンロード">
          <span class="icon">&#x1F4F7;</span> スマホに画像保存
        </button>
        <button id="btn-save" class="btn" title="PCサーバーに保存">
          <span class="icon">&#x1F4C1;</span> PCに画像保存
        </button>
        <button id="btn-settings" class="btn" title="設定">
          <span class="icon">&#x2699;</span> 設定
        </button>
      </div>
      <!-- Landscape: status info (hidden in portrait, shown in right panel) -->
      <div id="landscape-status" class="landscape-status">
        <span id="ls-fps">-- fps</span>
        <span id="ls-res">--</span>
        <span id="ls-audio">音声: --</span>
      </div>
    </div>
  </main>

  <!-- Settings Panel -->
  <div id="settings-panel" class="panel" hidden>
    <div class="panel-header">
      <h2>カメラ設定</h2>
      <button id="btn-settings-close" class="btn-close">&times;</button>
    </div>
    <div class="panel-body">
      <label>
        解像度
        <select id="setting-resolution">
          <option value="640x480">640x480</option>
          <option value="1280x720" selected>1280x720</option>
          <option value="1920x1080">1920x1080</option>
        </select>
      </label>
      <label>
        FPS
        <select id="setting-fps">
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="15" selected>15</option>
          <option value="30">30</option>
        </select>
      </label>
      <label>
        明るさ <span id="brightness-val">50</span>
        <input type="range" id="setting-brightness" min="0" max="100" value="50">
      </label>
      <label>
        コントラスト <span id="contrast-val">50</span>
        <input type="range" id="setting-contrast" min="0" max="100" value="50">
      </label>
      <div class="panel-actions">
        <button id="btn-apply" class="btn btn-primary">適用</button>
        <button id="btn-reset" class="btn">リセット</button>
      </div>
      <div id="passkey-register-section" class="passkey-section" hidden>
        <hr style="border-color: var(--border); margin: 1rem 0;">
        <label style="color: var(--text); font-weight: 600;">パスキー（生体認証）</label>
        <p style="font-size: 0.8rem; margin: 0.25rem 0 0.5rem;" id="passkey-status">確認中...</p>
        <button id="btn-passkey-register" class="btn btn-primary" style="width: 100%; justify-content: center;">
          &#x1F511; このデバイスを登録
        </button>
      </div>
    </div>
  </div>

  <!-- Status bar -->
  <footer id="status-bar">
    <span id="status-fps">-- fps</span>
    <span id="status-res">--</span>
    <span id="status-audio">音声: --</span>
  </footer>

  <script src="/static/js/webrtc.js"></script>
  <script src="/static/js/audio.js"></script>
  <script src="/static/js/app.js"></script>
  <script>
    // Viewport height fix: window.innerHeight is the actual visible area
    function setAppHeight() {
      document.documentElement.style.setProperty('--app-height', window.innerHeight + 'px');
    }
    setAppHeight();
    window.addEventListener('resize', setAppHeight);

    // Unlock screen orientation for PWA
    if (screen.orientation && screen.orientation.unlock) {
      screen.orientation.unlock().catch(() => {});
    }

    // Service Worker registration
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw.js")
        .then(reg => console.log("SW registered:", reg.scope))
        .catch(err => console.warn("SW registration failed:", err));
    }
    // Reload button
    document.getElementById("btn-reload").addEventListener("click", () => location.reload());
  </script>
</body>
</html>
