<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ğŸ¡DNG Camera</title>
  <meta name="description" content="è‡ªå®…ã®ãƒšãƒƒãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¦‹å®ˆã‚‹ã‚«ãƒ¡ãƒ©ã‚·ã‚¹ãƒ†ãƒ ">
  <meta name="theme-color" content="#0f1117">
  <meta name="mobile-web-app-capable" content="yes">
  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DNGCam">
  <link rel="apple-touch-icon" href="/static/img/apple-touch-icon.png">
  <!-- PWA Manifest & Icons -->
  <link rel="manifest" href="/static/manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/img/icon-192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/img/favicon.png">
  <link rel="stylesheet" href="/static/css/style.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <!-- Header -->
  <header id="header">
    <div class="header-left">
      <span class="logo">ğŸ¡DNG Camera</span>
    </div>
    <div class="header-center">
      <button id="btn-reload" class="btn-reload" title="ç”»é¢æ›´æ–°">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        <span class="btn-reload-text">ç”»é¢æ›´æ–°</span>
      </button>
    </div>
    <div class="header-right">
      <span id="live-badge" class="badge">LIVE</span>
      <span id="uptime">00:00:00</span>
    </div>
  </header>

  <!-- Video -->
  <main>
    <div class="video-container">
      <video id="video-stream-webrtc" autoplay playsinline muted hidden></video>
      <img id="video-stream-mjpeg" src="/video_feed" alt="Live Feed">
      <div id="video-overlay" class="overlay" hidden>
        <p>ã‚«ãƒ¡ãƒ©ã«æ¥ç¶šä¸­...</p>
      </div>
      <!-- PiP: self-preview during "é¡”ã‚’è¦‹ã›ã‚‹" -->
      <div id="owner-pip" class="owner-pip" hidden>
        <video id="owner-pip-video" playsinline muted></video>
      </div>
    </div>

    <!-- Exclusive session banner (shown when another device is using features) -->
    <div id="exclusive-banner" class="exclusive-banner" hidden>
      ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ãŒæ“ä½œä¸­ã®ãŸã‚ã€æ“ä½œã§ãã¾ã›ã‚“
    </div>

    <!-- Controls toggle button -->
    <button id="controls-toggle" class="controls-toggle" title="æ“ä½œãƒ‘ãƒãƒ«è¡¨ç¤º/éè¡¨ç¤º">
      <span id="controls-toggle-icon">&#x25B2;</span>
    </button>

    <!-- Controls panel (hideable) -->
    <div id="controls-panel">
      <!-- Row 1: Audio + Face + Volume -->
      <div class="controls">
        <button id="btn-listen" class="btn" title="å®¶ã®éŸ³ã‚’èã">
          <span class="icon">&#x1F50A;</span> èã
        </button>
        <button id="btn-talk" class="btn" title="æŠ¼ã—ã¦ã„ã‚‹é–“è©±ã™">
          <span class="icon">&#x1F3A4;</span> è©±ã™
        </button>
        <button id="btn-show-face" class="btn" title="ãƒ•ãƒ­ãƒ³ãƒˆã‚«ãƒ¡ãƒ©æ˜ åƒã‚’é€ä¿¡">
          <span class="icon">&#x1F4F9;</span> é¡”ã‚’è¦‹ã›ã‚‹
        </button>
        <label class="volume-control">
          <span>éŸ³é‡</span>
          <input type="range" id="volume-slider" min="0" max="100" value="80">
        </label>
      </div>

      <!-- Owner video status row (visible only when active) -->
      <div id="owner-video-status" class="owner-status-bar"></div>

      <!-- Row 2: Save + Settings -->
      <div class="controls">
        <button id="btn-snapshot" class="btn" title="ã‚¹ãƒãƒ›ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
          <span class="icon">&#x1F4F7;</span> ã‚¹ãƒãƒ›ã«ç”»åƒä¿å­˜
        </button>
        <button id="btn-save" class="btn" title="PCã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜">
          <span class="icon">&#x1F4C1;</span> PCã«ç”»åƒä¿å­˜
        </button>
        <button id="btn-settings" class="btn" title="è¨­å®š">
          <span class="icon">&#x2699;</span> è¨­å®š
        </button>
      </div>
      <!-- Landscape: status info (hidden in portrait, shown in right panel) -->
      <div id="landscape-status" class="landscape-status">
        <span id="ls-fps">-- fps</span>
        <span id="ls-res">--</span>
        <span id="ls-audio">éŸ³å£°: --</span>
      </div>
    </div>
  </main>

  <!-- Settings Panel -->
  <div id="settings-panel" class="panel" hidden>
    <div class="panel-header">
      <h2>ã‚«ãƒ¡ãƒ©è¨­å®š</h2>
      <button id="btn-settings-close" class="btn-close">&times;</button>
    </div>
    <div class="panel-body">
      <label>
        è§£åƒåº¦
        <select id="setting-resolution">
          <option value="640x480">640x480</option>
          <option value="1280x720" selected>1280x720</option>
          <option value="1920x1080">1920x1080</option>
        </select>
      </label>
      <label>
        FPS
        <select id="setting-fps">
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="15" selected>15</option>
          <option value="30">30</option>
        </select>
      </label>
      <label>
        æ˜ã‚‹ã• <span id="brightness-val">50</span>
        <input type="range" id="setting-brightness" min="0" max="100" value="50">
      </label>
      <label>
        ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ <span id="contrast-val">50</span>
        <input type="range" id="setting-contrast" min="0" max="100" value="50">
      </label>
      <div class="panel-actions">
        <button id="btn-apply" class="btn btn-primary">é©ç”¨</button>
        <button id="btn-reset" class="btn">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <div id="passkey-register-section" class="passkey-section" hidden>
        <hr style="border-color: var(--border); margin: 1rem 0;">
        <label style="color: var(--text); font-weight: 600;">ãƒ‘ã‚¹ã‚­ãƒ¼ï¼ˆç”Ÿä½“èªè¨¼ï¼‰</label>
        <p style="font-size: 0.8rem; margin: 0.25rem 0 0.5rem;" id="passkey-status">ç¢ºèªä¸­...</p>
        <button id="btn-passkey-register" class="btn btn-primary" style="width: 100%; justify-content: center;">
          &#x1F511; ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’ç™»éŒ²
        </button>
      </div>
    </div>
  </div>

  <!-- Status bar -->
  <footer id="status-bar">
    <span id="status-fps">-- fps</span>
    <span id="status-res">--</span>
    <span id="status-audio">éŸ³å£°: --</span>
  </footer>

  <!-- PWA Install Prompt -->
  <div id="pwa-install-overlay" class="pwa-install-overlay" hidden>
    <div class="pwa-install-dialog">
      <div class="pwa-icon">ğŸ¡</div>
      <h3>DNG Camera</h3>
      <p>ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã€ã‚¢ãƒ—ãƒªã¨ã—ã¦å¿«é©ã«ä½¿ãˆã¾ã™ã€‚</p>
      <button id="pwa-btn-install" class="pwa-btn-install">ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹</button>
      <button id="pwa-btn-dismiss" class="pwa-btn-dismiss">ã“ã®ã¾ã¾ãƒ–ãƒ©ã‚¦ã‚¶ã§è¡¨ç¤ºã™ã‚‹</button>
    </div>
  </div>

  <script src="/static/js/webrtc.js"></script>
  <script src="/static/js/audio.js"></script>
  <script src="/static/js/app.js"></script>
  <script>
    // Viewport height fix: window.innerHeight is the actual visible area
    function setAppHeight() {
      document.documentElement.style.setProperty('--app-height', window.innerHeight + 'px');
    }
    setAppHeight();
    window.addEventListener('resize', setAppHeight);

    // Unlock screen orientation for PWA
    if (screen.orientation && screen.orientation.unlock) {
      screen.orientation.unlock().catch(() => {});
    }

    // Service Worker registration
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw.js")
        .then(reg => console.log("SW registered:", reg.scope))
        .catch(err => console.warn("SW registration failed:", err));
    }
    // Reload button
    document.getElementById("btn-reload").addEventListener("click", () => location.reload());

    // PWA Install Prompt
    (function() {
      // Skip if already running as installed PWA
      if (window.matchMedia('(display-mode: standalone)').matches ||
          window.navigator.standalone === true) {
        return;
      }
      // Skip if user already dismissed
      if (localStorage.getItem('pwa-install-dismissed')) return;

      var deferredPrompt = null;
      var overlay = document.getElementById('pwa-install-overlay');
      var btnInstall = document.getElementById('pwa-btn-install');
      var btnDismiss = document.getElementById('pwa-btn-dismiss');

      window.addEventListener('beforeinstallprompt', function(e) {
        e.preventDefault();
        deferredPrompt = e;
        overlay.hidden = false;
      });

      btnInstall.addEventListener('click', function() {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(function(choice) {
          deferredPrompt = null;
          overlay.hidden = true;
        });
      });

      btnDismiss.addEventListener('click', function() {
        overlay.hidden = true;
        localStorage.setItem('pwa-install-dismissed', '1');
        deferredPrompt = null;
      });
    })();
  </script>
</body>
</html>
